<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise 实现 | Actual_Chao</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/css/0.styles.491af009.css" as="style"><link rel="preload" href="/assets/js/app.9d8f3547.js" as="script"><link rel="preload" href="/assets/js/4.13bd7c28.js" as="script"><link rel="preload" href="/assets/js/2.e137e48c.js" as="script"><link rel="preload" href="/assets/js/7.c0e220fc.js" as="script"><link rel="prefetch" href="/assets/js/10.c025b323.js"><link rel="prefetch" href="/assets/js/11.aff30d24.js"><link rel="prefetch" href="/assets/js/12.8bb88809.js"><link rel="prefetch" href="/assets/js/13.79dbcd28.js"><link rel="prefetch" href="/assets/js/14.e167532a.js"><link rel="prefetch" href="/assets/js/15.f702e40f.js"><link rel="prefetch" href="/assets/js/16.35cb3a9e.js"><link rel="prefetch" href="/assets/js/17.f05d26a8.js"><link rel="prefetch" href="/assets/js/18.9df8e545.js"><link rel="prefetch" href="/assets/js/19.b2792608.js"><link rel="prefetch" href="/assets/js/20.c4c25256.js"><link rel="prefetch" href="/assets/js/21.1f74d6b6.js"><link rel="prefetch" href="/assets/js/22.7b0b9da6.js"><link rel="prefetch" href="/assets/js/23.1d82e3d6.js"><link rel="prefetch" href="/assets/js/24.d98f95ae.js"><link rel="prefetch" href="/assets/js/25.dbab62b8.js"><link rel="prefetch" href="/assets/js/26.c8dbe9ca.js"><link rel="prefetch" href="/assets/js/27.f2a9b031.js"><link rel="prefetch" href="/assets/js/28.ce06e913.js"><link rel="prefetch" href="/assets/js/29.afef0a84.js"><link rel="prefetch" href="/assets/js/3.ab6c8af4.js"><link rel="prefetch" href="/assets/js/30.03cb84de.js"><link rel="prefetch" href="/assets/js/31.26208ec5.js"><link rel="prefetch" href="/assets/js/32.4a882a30.js"><link rel="prefetch" href="/assets/js/33.63acdde4.js"><link rel="prefetch" href="/assets/js/34.b09e067b.js"><link rel="prefetch" href="/assets/js/35.d62092ad.js"><link rel="prefetch" href="/assets/js/36.1e071235.js"><link rel="prefetch" href="/assets/js/37.81a80712.js"><link rel="prefetch" href="/assets/js/38.d066480a.js"><link rel="prefetch" href="/assets/js/39.b0316480.js"><link rel="prefetch" href="/assets/js/40.913fed9b.js"><link rel="prefetch" href="/assets/js/41.3029db88.js"><link rel="prefetch" href="/assets/js/42.f8b5c583.js"><link rel="prefetch" href="/assets/js/43.abbd37b9.js"><link rel="prefetch" href="/assets/js/44.6d4a8651.js"><link rel="prefetch" href="/assets/js/5.afb84be4.js"><link rel="prefetch" href="/assets/js/6.4fa78674.js"><link rel="prefetch" href="/assets/js/8.076ce93b.js"><link rel="prefetch" href="/assets/js/9.e1755c3d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.491af009.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><!----> <header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="Actual_Chao" class="logo"> <span class="site-name can-hide">Actual_Chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  近期文章
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  我的开源
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fontend/javascript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/rsa/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  VUE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="可视化" class="dropdown-title"><span class="title">可视化</span> <span class="arrow down"></span></button> <button type="button" aria-label="可视化" class="mobile-dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webgl/three/" class="nav-link">
  three
</a></li></ul></div></div><div class="nav-item"><a href="/map/" class="nav-link">
  地图
</a></div><div class="nav-item"><a href="https://github.com/actualchao/docs-vuepress-actualchao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  近期文章
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  我的开源
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fontend/javascript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link">
  HTTP
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/rsa/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  VUE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="可视化" class="dropdown-title"><span class="title">可视化</span> <span class="arrow down"></span></button> <button type="button" aria-label="可视化" class="mobile-dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webgl/three/" class="nav-link">
  three
</a></li></ul></div></div><div class="nav-item"><a href="/map/" class="nav-link">
  地图
</a></div><div class="nav-item"><a href="https://github.com/actualchao/docs-vuepress-actualchao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Javascript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fontend/javascript/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/fontend/javascript/array.html" class="sidebar-link">Array</a></li><li><a href="/fontend/javascript/arraySort.html" class="sidebar-link">Array.sort 算法原理</a></li><li><a href="/fontend/javascript/baseType.html" class="sidebar-link">数据类型</a></li><li><a href="/fontend/javascript/promise.html" aria-current="page" class="active sidebar-link">Promise 实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#promise-到底解决了什么问题" class="sidebar-link">Promise 到底解决了什么问题？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#回调地狱" class="sidebar-link">回调地狱</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#可读性问题" class="sidebar-link" style="padding-left:3rem;">可读性问题</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#信任问题" class="sidebar-link" style="padding-left:3rem;">信任问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#promise-如何解决这些问题" class="sidebar-link">Promise 如何解决这些问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#_1-0-terminology-概念术语" class="sidebar-link">1.0 Terminology 概念术语</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#_2-0-requirements-要求-实现" class="sidebar-link">2.0 Requirements 要求 （实现）</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#_2-1promise-states" class="sidebar-link" style="padding-left:3rem;">2.1Promise States</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#_2-2the-then-method" class="sidebar-link" style="padding-left:3rem;">2.2The then Method</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#_2-3the-promise-resolution-procedure" class="sidebar-link" style="padding-left:3rem;">2.3The Promise Resolution Procedure</a></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#promise-all-race-resolve-reject" class="sidebar-link" style="padding-left:3rem;">Promise.all/race/resolve/reject</a></li></ul></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#promise-规范测试" class="sidebar-link">Promise 规范测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#usage" class="sidebar-link" style="padding-left:3rem;">usage</a></li></ul></li><li class="sidebar-sub-header"><a href="/fontend/javascript/promise.html#generator-函数" class="sidebar-link">generator 函数</a></li></ul></li><li><a href="/fontend/javascript/string.html" class="sidebar-link">String 类型</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">本文引用文档地址</p> <ul><li><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer"> PromiseA+ 规范文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/6844903636737196045" target="_blank" rel="noopener noreferrer"> Promise到底解决了什么问题？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <h2 id="promise-到底解决了什么问题"><a href="#promise-到底解决了什么问题" class="header-anchor">#</a> Promise 到底解决了什么问题？</h2> <p>大家都知道 <strong>Promise</strong> 解决了回调地狱的问题，但是到底什么是回调地狱? 他到底哪儿<strong>have some  wrong</strong> ？
是因为嵌套回调还是，还是回调执行顺序问题，还是不够美观？</p> <div align="center"><img loading="lazy" src="/assets/img/primes1.31efba6b.jpeg" alt="回调地狱" style="width:100%;"></div> <h3 id="回调地狱"><a href="#回调地狱" class="header-anchor">#</a> 回调地狱</h3> <p>来脑补一下，实现一个说话的需求，说完才能说下一句，那么很容易的写出下面这样的一段代码</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">say</span> <span class="token punctuation">(</span><span class="token parameter">word<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    callback<span class="token operator">&amp;&amp;</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ok! fine!! 那么现在要说话了</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;third&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// first second third  end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在这个例子中的嵌套的问题仅仅是缩进的问题，而缩进除了会让代码变宽可能会造成读代码的一点不方便之外，并没有什么其他的问题。如果仅仅是这样，为什么不叫“缩进地狱”或“嵌套地狱”？</p> <p>把回调地狱完全理解成缩进的问题是常见的对回调地狱的误解。要回到“回调地狱”这个词语上面来，它的重点就在于“回调”，而“回调”在JS中应用最多的场景当然就是异步编程了。</p> <p>所以，“回调地狱”所说的嵌套其实是指异步的嵌套。它带来了两个问题：<strong>可读性的问题和信任问题</strong></p> <h4 id="可读性问题"><a href="#可读性问题" class="header-anchor">#</a> <strong>可读性问题</strong></h4> <p>很容易找到一个这样执行顺序问题的问题</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>很好，结果不那么重要，但是你总得想那么一会吧。想代码的执行顺序问题，那么你必须熟知异步代码的执行机制，还要能很快的分析出想要的结果，</p> <p>so 你能做到么。</p> <h4 id="信任问题"><a href="#信任问题" class="header-anchor">#</a> <strong>信任问题</strong></h4> <p>好的，让我们接着脑补一下，你是华夏某银行的少主，你的一个程序员写下了一段代码，调用了三方的ajax 扣款请求，但是由于三方库机制问题，调用了多次。</p> <p>那么，你能很好的信任回调么。还会不会有其他的信任问题发生呢。</p> <p>so</p> <ul><li>回调时机不对（早/晚）</li> <li>多次执行回调</li> <li>成功失败同时执行</li></ul> <p>...</p> <p>实际问题在于控制权转交给了第三方，不可控的执行导致了我们最头疼的信任问题，实际在开发中，我们需要检查的状态更多，依赖更多。信任问题带来的成本，就大大导致了可读性降低，需要更多的代码来check。</p> <p>虽然这些 fail 出现的概率并不高，可能在你编码的时候都没有关注到，但是实际上却需要很多臃肿的代码去强壮他，这就不够友好了。</p> <p>实际上万能的开发者们也想了很多方法来解决信任问题</p> <ul><li>for example</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 增加失败回调</span>
<span class="token keyword">function</span> <span class="token function">sendAjax</span><span class="token punctuation">(</span><span class="token parameter">onSuccess<span class="token punctuation">,</span>onFail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onSuccess<span class="token operator">&amp;&amp;</span><span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    onFail<span class="token operator">&amp;&amp;</span><span class="token function">onFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>example again</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node error first</span>
fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stat</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doSomeThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>实际上这并没有解决所有的问题，诸如回调多次执行，复杂场景下的回调问题。</p> <div class="custom-block tip"><p class="custom-block-title">小总结</p> <p>异步回调带来的问题主要集中在 <strong>可读性差</strong>/<strong>信任问题</strong></p></div> <h2 id="promise-如何解决这些问题"><a href="#promise-如何解决这些问题" class="header-anchor">#</a> Promise 如何解决这些问题</h2> <h3 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h3> <p>首先我们来看一下 <strong>PromiseA+</strong> 规范的第一句话</p> <p><strong>An open standard for sound, interoperable JavaScript promises—by implementers, for implementers.</strong></p> <p>一个开放的标准，用于实施者对实施者的声音，可互操作的JavaScript保证。</p> <details class="custom-block details"><summary>查看更多</summary> <p>A promise represents the eventual result of an asynchronous operation. The primary way of interacting with a promise is through its then method, which registers callbacks to receive either a promise’s eventual value or the reason why the promise cannot be fulfilled.</p> <p>一个promise表示异步操作的最终结果。 与诺言互动的主要方式是通过then方法，该方法注册回调以接收诺言的最终值或诺言无法实现的原因。</p> <p>This specification details the behavior of the then method, providing an interoperable base which all Promises/A+ conformant promise implementations can be depended on to provide. As such, the specification should be considered very stable. Although the Promises/A+ organization may occasionally revise this specification with minor backward-compatible changes to address newly-discovered corner cases, we will integrate large or backward-incompatible changes only after careful consideration, discussion, and testing.</p> <p>该规范详细说明了then方法的行为，提供了一个可互操作的基础，所有Promises / A +符合诺言的实现都可以依靠该基础来提供。 因此，该规范应被视为非常稳定。 尽管Promises / A +组织有时会通过向后兼容的微小更改来修订此规范，以解决新发现的极端情况，但只有经过仔细考虑，讨论和测试之后，我们才会集成大型或向后不兼容的更改。</p></details> <h3 id="_1-0-terminology-概念术语"><a href="#_1-0-terminology-概念术语" class="header-anchor">#</a> <code>1.0</code> Terminology 概念术语</h3> <ul><li><code>promise</code> is an object or function with a then method whose behavior conforms to this specification.</li> <li><code>thenable</code> is an object or function that defines a then method.</li> <li><code>value</code> is any legal JavaScript value (including undefined, a thenable, or a promise).</li> <li><code>exception</code> is a value that is thrown using the throw statement.</li> <li><code>reason</code> is a value that indicates why a promise was rejected.</li></ul> <h3 id="_2-0-requirements-要求-实现"><a href="#_2-0-requirements-要求-实现" class="header-anchor">#</a> <code>2.0</code> Requirements 要求 （实现）</h3> <p>对于创建一个可互操作的<strong>javascript</strong>保证的标准来说，要解决的问题无非就是状态管理，注册回调事件，和可靠的承诺解决体系</p> <p>**PromiseA+**规范实际上就从这三点出发，定义了三种标准。</p> <p>那么我们来开始写我们的代码，基于<code>es6 class</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// PromiseA+...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_2-1promise-states"><a href="#_2-1promise-states" class="header-anchor">#</a> <code>2.1</code>Promise States</h4> <p>A promise must be in one of three states: pending, fulfilled, or rejected.</p> <p>一个<code>Promise</code> 必须处于<code>pending``fulfilled``rejected</code>三种状态之间</p> <ul><li><code>2.1.1</code>When pending, a promise:
<ul><li><code>2.1.1.1</code>may transition to either the fulfilled or rejected state.</li></ul></li> <li><code>2.1.2</code>When fulfilled, a promise:
<ul><li><code>2.1.2.1</code>must not transition to any other state.</li> <li><code>2.1.2.2</code>must have a value, which must not change.</li></ul></li> <li><code>2.1.3</code>When rejected, a promise:
<ul><li><code>2.1.3.1</code>must not transition to any other state.</li> <li><code>2.1.3.2</code>must have a reason, which must not change.
Here, “must not change” means immutable identity (i.e. ===), but does not imply deep immutability.</li></ul></li></ul> <p>这里实际上定义了<code>Promise</code> 的状态转换关系，定义了</p> <ul><li>初始<code>pending</code>状态，可以转换为其他两个状态</li> <li>处于成功失败状态不能够转换到其他状态，必须有对应的成功值value or 失败原因reason</li> <li>失败状态原因引用不可更改</li></ul> <p>so！！！ do it</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义初始化状态常量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>


    <span class="token comment">// PromiseA+ 2.1.1.1</span>
    <span class="token comment">// 初始化状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>

    <span class="token comment">// PromiseA+ 2.1</span>
    <span class="token comment">// 定义缓存通过then注册的成功失败回调的数组，支持 then 方法注册多个回调</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onResolveCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 缓存this，避免this指向问题导致bug</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义成功失败方法，作为Promise 传入的函数体的参数</span>
    <span class="token comment">// 实现PromiseA+状态转换 定义成功失败参数</span>
    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Here, “must not change” means immutable identity (i.e. ===), but does not imply deep immutability.</span>
      <span class="token keyword">const</span> reason <span class="token operator">=</span> v<span class="token punctuation">;</span>
      <span class="token comment">//PromiseA+ 2.1.3</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onRejectCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">item</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.1.2</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onResolveCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">item</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 开始执行函数体，捕获错误。执行报错则直接拒绝Promise</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>:kissing</p> <p><code>new Promise</code>过程已经实现了</p> <h4 id="_2-2the-then-method"><a href="#_2-2the-then-method" class="header-anchor">#</a> <code>2.2</code>The then Method</h4> <p>A promise must provide a then method to access its current or eventual value or reason.</p> <p>A promise’s then method accepts two arguments:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么在类上定义方法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// PromiseA+ 2.2 // PromiseA+ 2.2.6</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><p><code>2.2.1</code> Both onFulfilled and onRejected are optional arguments:</p> <ul><li><code>2.2.1.1</code> If onFulfilled is not a function, it must be ignored.</li> <li><code>2.2.1.2</code> If onRejected is not a function, it must be ignored.</li></ul></li> <li><p><code>2.2.2</code> If onFulfilled is a function:</p> <ul><li><code>2.2.2.1</code> it must be called after promise is fulfilled, with promise’s value as its first argument.</li> <li><code>2.2.2.2</code> it must not be called before promise is fulfilled.</li> <li><code>2.2.2.3</code> it must not be called more than once.</li></ul></li> <li><p><code>2.2.3</code> If onRejected is a function,</p> <ul><li><code>2.2.3.1</code> it must be called after promise is rejected, with promise’s reason as its first argument.</li> <li><code>2.2.3.2</code> it must not be called before promise is rejected.</li> <li><code>2.2.3.3</code> it must not be called more than once.</li></ul></li></ul> <blockquote><ul><li>成功/失败回调必须是一个<code>funciton</code>，不是函数将被忽略</li> <li><code>成功/失败回调</code>必须在 <code>成功/失败</code> 之后被调用，第一个参数必须是<code>value/reason</code></li> <li><code>成功/失败回调</code>不能调用多次</li></ul></blockquote> <ul><li><code>2.2.4</code>onFulfilled or onRejected must not be called until the execution context stack contains only platform code. [3.1].</li></ul> <blockquote><p><code>成功/失败回调</code> 不能在Promise 平台代码执行完之前被调用，意义在于防止调用时还有回调没有被注册进来</p></blockquote> <ul><li><code>2.2.5</code>onFulfilled and onRejected must be called as functions (i.e. with no this value). [3.2]</li></ul> <blockquote><p><code>成功/失败回调</code> 必须作为函数被调用，如果拿到的参数不是函数，忽略它，生成默认的同步执行函数，以相同的值执行后续回调</p></blockquote> <ul><li><code>2.2.6</code>then may be called multiple times on the same promise.
<ul><li><code>2.2.6.1</code>If/when promise is fulfilled, all respective onFulfilled callbacks must execute in the order of their originating calls to then.</li> <li><code>2.2.6.2</code>If/when promise is rejected, all respective onRejected callbacks must execute in the order of their originating calls to then.</li></ul></li></ul> <blockquote><ul><li><code>then</code> 方法可能被同一个<code>promise</code> 调用多次</li> <li><code>then</code> 方法注册的<code>成功/失败回调</code>必须被以注册的顺序执行</li></ul></blockquote> <ul><li><code>2.2.7</code>then must return a promise [3.3].
<ul><li><code>2.2.7.1</code>If either onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).</li> <li><code>2.2.7.2</code>If either onFulfilled or onRejected throws an exception e, promise2 must be rejected with e as the reason.</li> <li><code>2.2.7.3</code>If onFulfilled is not a function and promise1 is fulfilled, promise2 must be fulfilled with the same value as promise1.</li> <li><code>2.2.7.4</code>If onRejected is not a function and promise1 is rejected, promise2 must be rejected with the same reason as promise1.</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><ul><li><code>then</code> 方法必须返回一个<code>Promise instance</code></li> <li><code>promise1</code> 成功或则失败回调正确执行拿到一个返回值<code>value x</code> 运行<code>Promise Resolution Procedure</code>解析程序<code>[Resolve]](promise2, x)</code></li> <li><code>promise1</code> 拒绝<code>throws an exception e</code> ，就以相同的原因拒绝<code>promise2</code></li> <li><code>promise1</code> 的 <code>成功/失败回调</code> 不是一个<code>function</code> 而且<code>promise1</code> 成功/失败时，<code>promise2</code>必须以相同的<code>value</code>/<code>e</code> 被成功或者拒绝</li></ul></blockquote> <p>so!!! do it!!!</p> <p><code>PromiseA+ 2.2.4</code> onFulfilled or onRejected must not be called until the execution context stack contains only platform code.</p> <p>为了防止在平台代码执行完毕，完全注册回调之前调用回调，采用宏任务<code>setTimeout0</code>实现</p> <details class="custom-block details"><summary>展开查看constructor</summary> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span><span class="token comment">//初始态</span>
  <span class="token comment">//PromiseA+ 2.1.1.1</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>

  <span class="token comment">// PromiseA+ 2.1</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onResolveCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> reason <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token comment">// PromiseA+ 2.2.4</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.1.3</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token comment">// console.dir(self);</span>
        <span class="token comment">// console.log('------self--------------------------------');</span>
        self<span class="token punctuation">.</span>onRejectCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">item</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// PromiseA+ 2.2.4</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.1.2</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onResolveCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">item</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div></details> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  

  <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  <span class="token comment">// PromiseA+ 2.2 // PromiseA+ 2.2.6</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//缓存this</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//PromiseA+ 2.2.1 / PromiseA+ 2.2.5 / PromiseA+ 2.2.7.3 / PromiseA+ 2.2.7.4</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> promise2<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">fulfillCallback</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.2.4</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//PromiseA+ 2.2.7.1</span>
          self<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//PromiseA+ 2.2.7.2</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">rejectCallback</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.2.4</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//PromiseA+ 2.2.7.1</span>
          self<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> e<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//PromiseA+ 2.2.7.2</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// PromiseA+ 2.2.2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.2.7</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fulfillCallback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token comment">// PromiseA+ 2.2.3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.2.7</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">rejectCallback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//PromiseA+ 2.2.7</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onResolveCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">fulfillCallback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        self<span class="token punctuation">.</span>onRejectCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">rejectCallback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>so 2.2.7.1 是个什么鬼！！鬼！！鬼啊！！！！</p> <p>接着看下去吧</p> <h4 id="_2-3the-promise-resolution-procedure"><a href="#_2-3the-promise-resolution-procedure" class="header-anchor">#</a> <code>2.3</code>The Promise Resolution Procedure</h4> <div class="custom-block danger"><p class="custom-block-title">交互性 javascript 保证</p> <p>If either onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).</p> <p><code>promise1</code> 成功或则失败回调正确执行拿到一个返回值<code>value x</code> 运行<code>Promise Resolution Procedure</code>解析程序<code>[Resolve]](promise2, x)</code></p></div> <p>The promise resolution procedure is an abstract operation taking as input a promise and a value, which we denote as [[Resolve]](promise, x). If x is a thenable, it attempts to make promise adopt the state of x, under the assumption that x behaves at least somewhat like a promise. Otherwise, it fulfills promise with the value x.</p> <p>This treatment of thenables allows promise implementations to interoperate, as long as they expose a Promises/A+-compliant then method. It also allows Promises/A+ implementations to “assimilate” nonconformant implementations with reasonable then methods.</p> <blockquote><p><code>promise resolution procedure</code>promise 解决程序实际上是一种承诺实现的抽象，将<code>promise</code> 和值<code>x</code> 作为输入，表示为<code>[[Resolve]]（promise，x)</code> 如果x是可能的，则在x的行为至少类似于承诺的假设下，尝试使承诺采用x的状态。 否则，它将以值x履行承诺。</p> <p>这种对可实现对象的处理使答应实现可以互操作，只要它们公开了符合Promises / A +的then方法即可。 它还允许Promises / A +实现使用合理的then方法“整合”不合格的实现。</p></blockquote> <p>想要运行 <code>promise resolution procedure</code>， 需要遵循瞎下面的规范。</p> <ul><li><code>2.3.1</code> If promise and x refer to the same object, reject promise with a TypeError as the reason.</li></ul> <blockquote><p>如果<code>promise</code> 和<code>x</code>指向同一个对象，以一个<code>TypeError</code>作为原因拒绝<code>promise</code></p></blockquote> <ul><li><code>2.3.2</code> If x is a promise, adopt its state [3.4]:
<ul><li><code>2.3.2.1</code> If x is pending, promise must remain pending until x is fulfilled or rejected.</li> <li><code>2.3.2.2</code> If/when x is fulfilled, fulfill promise with the same value.</li> <li><code>2.3.2.3</code> If/when x is rejected, reject promise with the same reason.</li></ul></li></ul> <blockquote><p>如果<code>x</code>是一个<code>promise</code>（是自己的实例<code>instanceof</code>） 采用下面的状态</p> <ul><li>如果<code>x</code>在<code>pending</code>状态，<code>promise2</code>必须保持<code>pending</code>状态直到<code>x</code>被<code>fulfilled/rejected</code></li> <li>如果<code>x</code> 被 <code>fulfilled/rejected</code>，<code>promise2</code> 必须保持 <code>x</code> 相同的 <code>value/reason</code> 被 <code>fulfilled/rejected</code></li></ul></blockquote> <ul><li><p><code>2.3.3</code> Otherwise, if x is an object or function,</p> <ul><li><p><code>2.3.3.1</code> Let then be x.then. [3.5]</p></li> <li><p><code>2.3.3.2</code> If retrieving the property x.then results in a thrown exception e, reject promise with e as the reason.</p></li> <li><p><code>2.3.3.3</code> If then is a function, call it with x as this, first argument resolvePromise, and second argument rejectPromise, where:</p> <ul><li><p><code>2.3.3.3.1</code> If/when resolvePromise is called with a value y, run [[Resolve]](promise, y).</p></li> <li><p><code>2.3.3.3.2</code> If/when rejectPromise is called with a reason r, reject promise with r.</p></li> <li><p><code>2.3.3.3.3</code> If both resolvePromise and rejectPromise are called, or multiple calls to the same argument are made, the first call takes precedence, and any further calls are ignored.</p></li> <li><p><code>2.3.3.3.4</code> If calling then throws an exception e,</p> <ul><li><code>2.3.3.3.4.1</code> If resolvePromise or rejectPromise have been called, ignore it.</li> <li><code>2.3.3.3.4.2</code> Otherwise, reject promise with e as the reason.</li></ul></li></ul></li> <li><p><code>2.3.3.4</code> If then is not a function, fulfill promise with x.</p></li></ul></li> <li><p><code>2.3.3.4</code> If x is not an object or function, fulfill promise with x.</p></li></ul> <blockquote><p>当<code>x</code> 是一个<code>object</code> or <code>function</code> 此时可能是一个同步的处理函数，也可能是一个<code>thenable</code> 对象</p></blockquote> <blockquote><ul><li>访问<code>x</code>的<code>then</code> 属性 实际上该操作可能会报错，一般来说访问一个对象的属性不会报错，但是如果该属性是一个 <code>getter</code> 的时候，在执行<code>getter</code> 的时候可能会抛异常<code>e</code>。此时应该以<code>e</code> 来拒绝<code>peomise2</code></li></ul></blockquote> <blockquote><ul><li>当<code>then</code> 是一个<code>function</code>，通过<code>then.call(x)</code>调用它，同时给<code>x</code>注册成功处理函数和失败处理函数，
<ul><li>当成功回调被执行并传入<code>y</code>的时候，运行<code>[[Resolve]](promise, y)</code> 继续解析。</li> <li>当失败回调被执行并传入<code>e</code>的时候，把<code>e</code>作为<code>reason</code>拒绝<code>promise2</code></li></ul></li></ul></blockquote> <blockquote><ul><li>如果成功失败回调被多次调用，那么第一次的调用将优先调用，其他的调用将被忽略，这里需要添加<code>called</code> 标志是否被调用，在每次调用成功失败时校验，并调用时立马修改标志位状态</li> <li>如果x不是<code>function</code> 对象那么以<code>x</code>实现<code>promise</code></li> <li>如果x不是<code>thenable</code> 对象那么以<code>x</code>实现<code>promise</code></li></ul></blockquote> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>解析程序实际上保证了<code>promise</code> 的可靠性，对<code>thenable</code>对象状态的判断，循环解析，直到<code>x</code>作为一个普通的不能在被解析的非<code>thenable</code>才实现调用，对错误的处理也贯彻整个流程，而且保证了调用的唯一性。
这实现了那句<strong>可互操作的JavaScript保证。</strong></p></div> <p>那么，让我们来一步一步的实现它吧</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// PromiseA+ 2.3.1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'循环引用'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>


  <span class="token comment">// PromiseA+ 2.3.2</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> self<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.3.2.1</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> self<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.3.2.2  /PromiseA+ 2.3.2.3</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// PromiseA+ 2.3.3</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// PromiseA+ 2.3.3.3.3  / PromiseA+ 2.3.3.3.4.1</span>
    <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.3.3.1</span>
      <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token comment">// PromiseA+ 2.3.3.3</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
            x<span class="token punctuation">,</span>
            <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token comment">// PromiseA+ 2.3.3.3.1</span>
              self<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token comment">// PromiseA+ 2.3.3.3.2</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">// PromiseA+ 2.3.3.3.2</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// PromiseA+ 2.3.3.4</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// PromiseA+ 2.3.3.2 / PromiseA+ 2.3.3.4.2</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// PromiseA+ 2.3.4</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="promise-all-race-resolve-reject"><a href="#promise-all-race-resolve-reject" class="header-anchor">#</a> Promise.all/race/resolve/reject</h4> <p>到此<code>PromiseA+</code>规范已经完全实现，原则上所有的<code>Promise</code> 库都应该遵循此规范，现代浏览器支持的<code>promise</code> 都支持一些<code>Promise.all</code>，<code>Promise.race</code>，<code>Promise.resolve</code>，<code>Promise.reject</code>，接下来让我们来实现它</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//all 实现</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//promises是一个promise的数组</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//arr是最终返回值的结果</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 表示成功了多少次</span>
    <span class="token keyword">function</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processData</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// race 实现</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Promise.resolve 实现</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Promise.reject 实现</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="promise-规范测试"><a href="#promise-规范测试" class="header-anchor">#</a> Promise 规范测试</h2> <p><a href="https://github.com/promises-aplus/promises-tests" target="_blank" rel="noopener noreferrer">Promises/A+ 一致化测试套件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="usage"><a href="#usage" class="header-anchor">#</a> usage</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> promises-aplus-tests -g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试套件实际上是一个cli命令行工具，只需要在Promise 上暴露出一个<code>fucntion</code>接口<code>deferred</code>,函数返回一个对象，对象包含一个Promise 实例，和实例的resolve,reject 参数</p> <p>Adapters
In order to test your promise library, you must expose a very minimal adapter interface. These are written as Node.js modules with a few well-known exports:</p> <ul><li>resolved(value): creates a promise that is resolved with value.</li> <li>rejected(reason): creates a promise that is already rejected with reason.</li> <li>deferred(): creates an object consisting of { promise, resolve, reject }:
<ul><li>promise is a promise that is currently in the pending state.</li> <li>resolve(value) resolves the promise with value.</li> <li>reject(reason) moves the promise from the pending state to the rejected state, with rejection reason reason.</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>进入到<code>Promise.js</code>所在目录，运行</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>promises-aplus-tests ./Promise.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>or in package.json</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;testa:promise&quot;</span><span class="token operator">:</span> <span class="token string">&quot;promises-aplus-tests ./src/promise/Promise.js&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么顺利的话！ 你讲看到这个</p> <div align="center"><img loading="lazy" src="/assets/img/promise-done.3742ba1f.png" alt="回调地狱" style="width:100%;"></div> <h2 id="generator-函数"><a href="#generator-函数" class="header-anchor">#</a> generator 函数</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fontend/javascript/baseType.html" class="prev">
        数据类型
      </a></span> <span class="next"><a href="/fontend/javascript/string.html">
        String 类型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9d8f3547.js" defer></script><script src="/assets/js/4.13bd7c28.js" defer></script><script src="/assets/js/2.e137e48c.js" defer></script><script src="/assets/js/7.c0e220fc.js" defer></script>
  </body>
</html>
