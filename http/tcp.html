<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP 协议 | Actual_Chao</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/css/0.styles.491af009.css" as="style"><link rel="preload" href="/assets/js/app.9d8f3547.js" as="script"><link rel="preload" href="/assets/js/4.13bd7c28.js" as="script"><link rel="preload" href="/assets/js/2.e137e48c.js" as="script"><link rel="preload" href="/assets/js/5.afb84be4.js" as="script"><link rel="prefetch" href="/assets/js/10.c025b323.js"><link rel="prefetch" href="/assets/js/11.aff30d24.js"><link rel="prefetch" href="/assets/js/12.8bb88809.js"><link rel="prefetch" href="/assets/js/13.79dbcd28.js"><link rel="prefetch" href="/assets/js/14.e167532a.js"><link rel="prefetch" href="/assets/js/15.f702e40f.js"><link rel="prefetch" href="/assets/js/16.35cb3a9e.js"><link rel="prefetch" href="/assets/js/17.f05d26a8.js"><link rel="prefetch" href="/assets/js/18.9df8e545.js"><link rel="prefetch" href="/assets/js/19.b2792608.js"><link rel="prefetch" href="/assets/js/20.c4c25256.js"><link rel="prefetch" href="/assets/js/21.1f74d6b6.js"><link rel="prefetch" href="/assets/js/22.7b0b9da6.js"><link rel="prefetch" href="/assets/js/23.1d82e3d6.js"><link rel="prefetch" href="/assets/js/24.d98f95ae.js"><link rel="prefetch" href="/assets/js/25.dbab62b8.js"><link rel="prefetch" href="/assets/js/26.c8dbe9ca.js"><link rel="prefetch" href="/assets/js/27.f2a9b031.js"><link rel="prefetch" href="/assets/js/28.ce06e913.js"><link rel="prefetch" href="/assets/js/29.afef0a84.js"><link rel="prefetch" href="/assets/js/3.ab6c8af4.js"><link rel="prefetch" href="/assets/js/30.03cb84de.js"><link rel="prefetch" href="/assets/js/31.26208ec5.js"><link rel="prefetch" href="/assets/js/32.4a882a30.js"><link rel="prefetch" href="/assets/js/33.63acdde4.js"><link rel="prefetch" href="/assets/js/34.b09e067b.js"><link rel="prefetch" href="/assets/js/35.d62092ad.js"><link rel="prefetch" href="/assets/js/36.1e071235.js"><link rel="prefetch" href="/assets/js/37.81a80712.js"><link rel="prefetch" href="/assets/js/38.d066480a.js"><link rel="prefetch" href="/assets/js/39.b0316480.js"><link rel="prefetch" href="/assets/js/40.913fed9b.js"><link rel="prefetch" href="/assets/js/41.3029db88.js"><link rel="prefetch" href="/assets/js/42.f8b5c583.js"><link rel="prefetch" href="/assets/js/43.abbd37b9.js"><link rel="prefetch" href="/assets/js/44.6d4a8651.js"><link rel="prefetch" href="/assets/js/6.4fa78674.js"><link rel="prefetch" href="/assets/js/7.c0e220fc.js"><link rel="prefetch" href="/assets/js/8.076ce93b.js"><link rel="prefetch" href="/assets/js/9.e1755c3d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.491af009.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><!----> <header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="Actual_Chao" class="logo"> <span class="site-name can-hide">Actual_Chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  近期文章
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  我的开源
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fontend/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link router-link-active">
  HTTP
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/rsa/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  VUE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="可视化" class="dropdown-title"><span class="title">可视化</span> <span class="arrow down"></span></button> <button type="button" aria-label="可视化" class="mobile-dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webgl/three/" class="nav-link">
  three
</a></li></ul></div></div><div class="nav-item"><a href="/map/" class="nav-link">
  地图
</a></div><div class="nav-item"><a href="https://github.com/actualchao/docs-vuepress-actualchao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  近期文章
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  我的开源
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fontend/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link router-link-active">
  HTTP
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/rsa/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  VUE
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="可视化" class="dropdown-title"><span class="title">可视化</span> <span class="arrow down"></span></button> <button type="button" aria-label="可视化" class="mobile-dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webgl/three/" class="nav-link">
  three
</a></li></ul></div></div><div class="nav-item"><a href="/map/" class="nav-link">
  地图
</a></div><div class="nav-item"><a href="https://github.com/actualchao/docs-vuepress-actualchao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Http</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/http/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/http/tcp.html" aria-current="page" class="active sidebar-link">TCP 协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/http/tcp.html#描述" class="sidebar-link">描述</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#为什么要有-tcp" class="sidebar-link">为什么要有 TCP</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#面向连接" class="sidebar-link">面向连接</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#可靠性" class="sidebar-link">可靠性</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#tcp-协议首部" class="sidebar-link">TCP 协议首部</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/http/tcp.html#抓包" class="sidebar-link">抓包</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#source-port-源端口号" class="sidebar-link">Source Port 源端口号</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#destination-port-目标端口号" class="sidebar-link">Destination Port 目标端口号</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#sequence-number-序列号" class="sidebar-link">Sequence Number 序列号</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#acknowledgment-number-确认号" class="sidebar-link">Acknowledgment Number 确认号</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#header-length-头部长度" class="sidebar-link">Header Length 头部长度</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#保留位" class="sidebar-link">保留位</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#标识位" class="sidebar-link">标识位</a></li></ul></li><li class="sidebar-sub-header"><a href="/http/tcp.html#三次握手" class="sidebar-link">三次握手</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#tcp的四次挥手" class="sidebar-link">TCP的四次挥手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/http/tcp.html#四次挥手的原因" class="sidebar-link">四次挥手的原因</a></li><li class="sidebar-sub-header"><a href="/http/tcp.html#为什么建立连接协议是三次握手-而关闭连接却是四次握手呢" class="sidebar-link">为什么建立连接协议是三次握手，而关闭连接却是四次握手呢？</a></li></ul></li></ul></li><li><a href="/http/tcpip.html" class="sidebar-link">TCP/IP 网络模型</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp-协议-详解"><a href="#tcp-协议-详解" class="header-anchor">#</a> TCP 协议 详解</h1> <h2 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h2> <p>是一种面向连接的、可靠的、传输控制协议.</p> <p>TCP将用户数据打包构成报文段，它发送数据时启动一个定时器，另一端收到数据进行确认，对失序的数据重新排序，丢弃重复的数据</p> <h2 id="为什么要有-tcp"><a href="#为什么要有-tcp" class="header-anchor">#</a> 为什么要有 TCP</h2> <p>TCP 协议是建立在IP 协议之上 为了解决 IP 协议无法保证可靠性的问题而提出的一种上层传输控制协议.下面是 IP 协议的描述</p> <div class="custom-block tip"><p class="custom-block-title">IP 协议的描述</p> <p>IP 协议根据端到端的设计原则，IP只为主机提供一种无连接、不可靠的、尽力而为的数据包传输服务。</p> <p>IP主要包含三方面内容：IP编址方案、分组封装格式及分组转发规则。</p> <p>用我们的话来说,就是IP 只负责运输只一个消息,,他不会关注消息是什么,也不会关心消息是否发送到,它只负责发出去和接收.</p></div> <h2 id="面向连接"><a href="#面向连接" class="header-anchor">#</a> 面向连接</h2> <p>TCP 主要用于上层应用层的应用程序之间的消息传递,提供的是 <code>端到端的字节流传输服务</code>,也就是源端口到目标端口的数据传输,应用程序监听着计算机端口,拿到传递的数据.</p> <p>要保证信息传递的可靠性,首先就要建立连接,脑补一下打电话和发微信消息的区别,你就能领会 TCP 和 UDP 的区别.</p> <p>当应用程序希望通过 TCP 与另一个应用程序通信时，它会发送一个通信请求。这个请求必须被送到一个确切网卡地址所在计算机的确切端口。在双方“握手”之后，TCP 将在两个应用程序之间建立一个全双工 (full-duplex) 的通信。</p> <p>这个全双工的通信将占用两个计算机之间的通信线路，直到它被一方或双方关闭为止。</p> <p>面向连接的实现就是我们常说的:</p> <ul><li>TCP 三次握手</li> <li>四次挥手</li></ul> <h2 id="可靠性"><a href="#可靠性" class="header-anchor">#</a> 可靠性</h2> <ul><li>应用数据会根据带宽吞吐量、另一端发送缓存区能接纳的数据量等实时情况被分成TCP认为的最合适的发送数据块(流量控制)</li> <li>当TCP发送一个段(segment)之后，启动一个定时器，等待目的点确认收到报文，如果不能及时收到一个确认，将重发这个数据段(segment)。</li> <li>当TCP收到连接端发来的数据，就会推迟几分之一秒发送一个确认。</li> <li>TCP将保持它首部和数据的检验和，这是一个端对端的检验和，目的在于检测数据在传输过程中是否发生变化。（有错误，就不确认，发送端就会重发）</li> <li>TCP是以IP报文来传送，IP数据是无序的，TCP收到所有数据后进行排序，再交给应用层</li> <li>对 IP 网络层传回的数据进行去重.</li> <li>TCP对字节流不做任何解释，对字节流的解释由TCP连接的双方应用层解释。</li></ul> <h2 id="tcp-协议首部"><a href="#tcp-协议首部" class="header-anchor">#</a> TCP 协议首部</h2> <p>TCP 协议首部定义了用于实现 TCP 协议,面向连接,可靠性所必须的一些数据标识,根据这些标识, TCP 协议完成内部的逻辑转化,将最后校验好没有问题的数据传递给上层应用程序解析.</p> <p>每一层网络协议都有自己的首部,没经过一层模型,就会在数据包基础上,打上对应的首部信息.</p> <p>下面是 TCP 协议首部的报文格式</p> <p><img src="/assets/img/TCP_header.5897d792.jpg" alt=""></p> <h3 id="抓包"><a href="#抓包" class="header-anchor">#</a> 抓包</h3> <p>我们通过 wireshark 抓包工具,抓去网卡上的 TCP 连接包,通过分析包的数据来对照分析上面的报文格式对应的字段功能:</p> <div align="center"><img loading="lazy" src="/assets/img/segment.35cea65c.jpg" alt="插入排序动图" style="width:100%;"></div> <h3 id="source-port-源端口号"><a href="#source-port-源端口号" class="header-anchor">#</a> Source Port 源端口号</h3> <p>16位的源端口中包含初始化通信的端口。源端口和源IP地址的作用是标识建立连接请求的本机程序,也就是目标主机返回数据报文的地址.</p> <h3 id="destination-port-目标端口号"><a href="#destination-port-目标端口号" class="header-anchor">#</a> Destination Port 目标端口号</h3> <p>16位的目标端口中包含需要建立连接的 目标主机程序的通信端口, 用于标识要建立连接的目标主机程序,也就是当前报文发送的接收方.</p> <h3 id="sequence-number-序列号"><a href="#sequence-number-序列号" class="header-anchor">#</a> Sequence Number 序列号</h3> <p>32位的序列号由源主机生成, 由接收端计算机使用，当SYN 同步连接标识别出现，序列码实际上是初始序列码（Initial Sequence Number，ISN），而第一个数据字节是ISN+1。这个序列号（序列码）可用来补偿传输中的不一致。</p> <p>实际上就是当前发送的 TCP Segment 数据报的序号.用于对数据报文的重组等操作.</p> <h3 id="acknowledgment-number-确认号"><a href="#acknowledgment-number-确认号" class="header-anchor">#</a> Acknowledgment Number 确认号</h3> <p>32位的序列号由源主机生成,由接收端计算机使用，如果设置了ACK控制位，这个值表示一个准备接收的包的序列码, 也就是标示这哥序列号之前的 数据报文都已经确认接收到.</p> <h3 id="header-length-头部长度"><a href="#header-length-头部长度" class="header-anchor">#</a> Header Length 头部长度</h3> <p>4位头部长度包括TCP头大小，指示何处数据开始。</p> <h3 id="保留位"><a href="#保留位" class="header-anchor">#</a> 保留位</h3> <p>6位保留位,用于未来扩展.</p> <h3 id="标识位"><a href="#标识位" class="header-anchor">#</a> 标识位</h3> <p>6位标志域。</p> <ul><li><p><strong>URG 紧急标志</strong></p> <p>与 Urgent Pointer 配合使用,设置紧急数据,用于 TCP 在处理的时候紧急数据不进入缓冲区直接交给上层应用层处理.例如中断命令 ctrl + c</p> <p>当URG 标志被设置的时候(值为1),Urgent Pointer有效,指示紧急数据长度.从 sequence Number 开始, Urgent Pointer 长度的长度为紧急数据. sequence Number + Urgent Pointer 位置开始为正常数据.</p></li> <li><p><strong>ACK 有意义的应答标志</strong></p> <p>确认编号(Acknowledgement Number)栏有效。大多数情况下该标志位是置位的。TCP报头内的确认编号栏内包含的确认编号(w+1，Figure-1)为下一个预期的序列编号，同时提示远端系统已经成功接收所有数据。</p></li> <li><p><strong>PSH 推送标识</strong></p> <p>该标志置位时，接收端不将该数据进行队列处理，而是尽可能快将数据转由应用处理。在处理 telnet 或 rlogin 等交互模式的连接时，该标志总是置位的。</p></li> <li><p><strong>RST 重置连接</strong></p> <p>复位标志有效。用于复位相应的TCP连接。</p></li> <li><p><strong>SYN 同步序列号</strong></p> <p>同步序列编号(Synchronize Sequence Numbers)栏有效。该标志仅在三次握手建立TCP连接时有效。它提示TCP连接的服务端检查序列编号，该序列编号为TCP连接初始端(一般是客户 端)的初始序列编号。在这里，可以把 TCP序列编号看作是一个范围从0到4，294，967，295的32位计数器。通过TCP连接交换的数据中每一个字节都经过序列编号。在TCP报头中的 序列编号栏包括了TCP分段中第一个字节的序列编号。</p></li> <li><p><strong>FIN 结束位</strong></p> <p>带有该标志置位的数据包用来结束一个TCP回话，但对应端口仍处于开放状态，准备接收后续数据。</p></li></ul> <h2 id="三次握手"><a href="#三次握手" class="header-anchor">#</a> 三次握手</h2> <p>上面提到了TCP标志位的含义, 在 TCP 三次握手过程中, 需要用到的是 SYN 同步标识位, 和 ACK 应答标识位.</p> <p>下面是通过抓包工具抓取的 TCP 三次握手连接的数据包,下面将通过这三个包展示握手连接过程.</p> <div align="center"><img loading="lazy" src="/assets/img/Tcp_hello.aeb40615.jpg" alt="tcp 三次握手" style="width:100%;"></div> <ol><li><strong>最初两端的TCP进程都处于CLOSE(关闭)状态。</strong></li> <li><strong>客户端向服务端发起连接请求,将 SYN 标识为设置位 1 (设置状态) ,标志连接请求,同时设置 sequence number 为 0 ,表示发送序号,此时确认序号 acknownldge number 为默认值 0.</strong></li> <li><strong>服务端 收到连接请求报文，如果同意建立连接，则向 客户端 发送连接确认报文,SYN=1，标志连接，ACK=1 设置应答标志，确认号为ack= 1, 表示当前 字节号 1 之前的数据已经全部收到,下次发送从1开始，同时也选择一个初始的序号 seq=0。</strong></li> <li><strong>客户端 收到连接请求报文，ACK=1 设置应答标志，确认号为ack= 1, 表示当前 字节号 1 之前的数据已经全部收到,下次发送从1开始，同时也选择一个初始的序号 seq=1。</strong></li> <li><strong>连接建立开始发送数据</strong></li></ol> <h2 id="tcp的四次挥手"><a href="#tcp的四次挥手" class="header-anchor">#</a> TCP的四次挥手</h2> <div align="center"><img loading="lazy" src="/assets/img/tcp_goodbye.8031a089.jpg" alt="tcp 三次握手" style="width:100%;"></div> <p>数据传输结束后，通信的双方都可释放连接。
此处为A的应用进程先向其TCP发出连接释放报文段，但是A结束TCP连接的时间要比B晚一些。</p> <p>以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。</p> <p>A 发送连接释放报文，FIN=1。
B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
当 B 不再需要连接时，发送连接释放报文，FIN=1。
A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
B 收到 A 的确认后释放连接。</p> <h3 id="四次挥手的原因"><a href="#四次挥手的原因" class="header-anchor">#</a> 四次挥手的原因</h3> <p>CLOSE-WAIT</p> <p>客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。</p> <p>TIME-WAIT</p> <p>客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。</p> <p>为什么A在TIME-WAIT状态必须等待2MSL的时间呢？</p> <p><strong>这么做有两个理由：</strong></p> <ul><li>为了保证A发送的最后一个ACK报文段能够到达B。
A发送的这个ACK报文段有可能丢失，如果 B 没收到 A 发送来的确认报文，那么A就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。</li> <li>防止“已经失效的连接请求报文段”出现在本链接中。
A在发送完最后一个ACK报文段后，再经过时间2MSL，就可以使本连接的时间内所产生的所有报文段都从网络中消失。这样下一个新的连接中就不会出现这种旧的连接请求报文段。</li></ul> <h3 id="为什么建立连接协议是三次握手-而关闭连接却是四次握手呢"><a href="#为什么建立连接协议是三次握手-而关闭连接却是四次握手呢" class="header-anchor">#</a> 为什么建立连接协议是三次握手，而关闭连接却是四次握手呢？</h3> <p>这是因为服务端的LISTEN状态下的SOCKET当收到SYN报文的连接请求后，它可以把ACK和SYN(ACK起应答作用，而SYN起同步作用)放在一个报文里来发送。但关闭连接时，当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了；但未必你所有的数据都全部发送给对方了，所以你可能未必会马上会关闭SOCKET,也即你可能还需要发送一些数据给对方之后，再发送FIN报文给对方来表示你同意现在可以关闭连接了，所以它这里的ACK报文和FIN报文多数情况下都是分开发送的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/http/" class="prev router-link-active">
        目录
      </a></span> <span class="next"><a href="/http/tcpip.html">
        TCP/IP 网络模型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9d8f3547.js" defer></script><script src="/assets/js/4.13bd7c28.js" defer></script><script src="/assets/js/2.e137e48c.js" defer></script><script src="/assets/js/5.afb84be4.js" defer></script>
  </body>
</html>
